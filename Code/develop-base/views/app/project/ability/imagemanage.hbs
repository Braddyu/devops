<!--<script src="{{projcfg.appurl}}/static/js/containerlistingdata.js" type="text/javascript"></script>-->
<link rel="stylesheet" href="{{projcfg.appurl}}/static/ability/editormd/css/editormd.css" />
<link type="text/css" rel="stylesheet" href="{{projcfg.appurl}}/static/ability/editormd/lib/codemirror/codemirror.min.css">

<!--<script src="/smart-api/htdocs/mdeditor/js/jquery.min.js"></script>-->
<script type="text/javascript" src="{{projcfg.appurl}}/static/ability/editormd/editormd.min.js"></script>
<script id="-lib-codemirror-codemirror-min" type="text/javascript" src="{{projcfg.appurl}}/static/ability/editormd/lib/codemirror/codemirror.min.js"></script>




<!--<link rel="stylesheet" href="{{projcfg.appurl}}/static/ability/editormd/css/editormd.min.css" />-->
<!--<link rel="stylesheet" href="{{projcfg.appurl}}/static/ability/editormd/css/editormd.css" />-->
<!--<link type="text/css" rel="stylesheet" href="{{projcfg.appurl}}/static/ability/editormd/lib/codemirror/codemirror.min.css">-->
<!--<link type="text/css" rel="stylesheet" href="{{projcfg.appurl}}/static/ability/editormd/lib/codemirror/lib/codemirror.css">-->
<!--<link type="text/css" rel="stylesheet" href="{{projcfg.appurl}}/static/ability/editormd/lib/codemirror/addon/search/matchesonscrollbar.css">-->
<!--<link type="text/css" rel="stylesheet" href="{{projcfg.appurl}}/static/ability/editormd/lib/codemirror/addon/dialog/dialog.css">-->
<!--<link rel="shortcut icon" href="https://pandao.github.io/editor.md/favicon.ico" type="image/x-icon">-->

<!--<script type="text/javascript" src="{{projcfg.appurl}}/static/ability/editormd/editormd.min.js"></script>-->
<!--<script id="-lib-codemirror-codemirror-min" type="text/javascript" src="{{projcfg.appurl}}/static/ability/editormd/lib/codemirror/codemirror.min.js"></script>-->
<!--<script id="-lib-marked-min" type="text/javascript" src="{{projcfg.appurl}}/static/ability/editormd/lib/marked.min.js"></script>-->
<!--<script id="-lib-codemirror-modes-min" type="text/javascript" src="{{projcfg.appurl}}/static/ability/editormd/lib/codemirror/modes.min.js"></script>-->
<!--<script id="-lib-codemirror-addons-min" type="text/javascript" src="{{projcfg.appurl}}/static/ability/editormd/lib/codemirror/addons.min.js"></script>-->
<!--<script id="-lib-codemirror-addons-min" type="text/javascript" src="{{projcfg.appurl}}/static/ability/editormd/lib/codemirror/prettify.min.js"></script>-->
<!--<script type="text/javascript" src="{{projcfg.appurl}}/static/ability/editormd/Gulpfile.js"></script>-->
<!--<script src="{{projcfg.appurl}}/static/ability/editormd/lib/codemirror/lib/codemirror.js"></script>-->
<script src="{{projcfg.appurl}}/static/ability/editormd/plugins/image-dialog/image-dialog.js"></script>

<style>
    .div-bor{
        position: relative;width: 100%;height: 35px;
        border-bottom: 1px solid #ccc;
        margin-bottom: 1rem;
    }
    .icon-serach{
        position: absolute;left: 0;z-index:5;
        background-image: url('{{projcfg.appurl}}/static/images/search.png'); /*引入图片图片*/
        background-repeat: no-repeat; /*设置图片不重复*/
        background-position: 1px 0px; /*图片显示的位置*/
        width: 20px; /*设置图片显示的宽*/
        height: 20px; /*图片显示的高*/
        top: 5px;
        left: 3px;
        cursor:pointer;
    }
    .serach{
        padding-left: 22px;
    }
    input[type=radio] {
        opacity: 1;
        position: relative;
        left: 2px;
        z-index: 12;
        width: 13px;
        height: 13px;
        cursor: pointer;
        margin: 1rem;
    }

</style>
<div class="row">
    <div class="col-xs-12 col-md-12">
        <div class="widget">
            <div class="widget-body">
                <div id="toolbar" class="row tbRow" style="margin-bottom: 1.1rem;border-bottom: 1px solid #ccc;">
                    <div class="col-xs-6 col-md-6" style="width:100%">
                        <font size="3.5rem" style="margin-left: 1.2rem;margin-right: 2.5rem"> <b>镜像管理</b></font>
                        <div class="btn-group" role="group" aria-label="...">
                          <!--  <button type="button" class="btn btn-default" onclick="openPage('addimage','新增镜像','',doAddAndModify)" data-title="新增镜像">
                                <i class="fa fa-edit"></i> 新增镜像
                            </button>-->
                            <button type="button" class="btn btn-default" onclick="modifyPage('addimage','修改镜像','',doAddAndModify)" data-title="修改镜像">
                                <i class="fa fa-edit"></i> 修改镜像
                            </button>
                          <!--  <button type="button" class="btn btn-default" onclick="doDelete()" data-title="删除镜像">
                                <i class="fa fa-edit"></i> 删除镜像
                            </button>-->
                        </div>

                    </div>
                </div>
                <div id="cc" class="easyui-layout" data-options="fit:true,border:false" style="width: 800px; height:575px;background-color: #fbfbfb;">
                    <div id="images" data-options="region:'center',border:false" style="overflow-x:hidden;overflow-y:hidden">
                        <div id="datagridPanel" style="width:100%;height: 100%;">
                            <table id="myImageDataTable">
                            </table>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>
<div>

</div>


<div id="addimage" class="mydialog"  data-options="iconCls:'icon-save'">
    <div class="row">
        <div class="col-md-12">
            <div>
                <form id="imageForm" class="form-horizontal form-bordered" role="form" method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <div class="col-sm-4 col-xs-4">
                            <label for="imageName" class="col-sm-3 control-label no-padding-right">镜像名称:</label>
                            <div class="col-sm-9">
                                <input type="text" class="easyui-validatebox form-control" data-options="required:true" name="imageName" id="imageName" placeholder="请输入镜像名称" style="width:60%">
                            </div>
                        </div>

                        <div class="col-sm-4 col-xs-4">
                            <label for="iamgeResource"  class="col-sm-3 control-label no-padding-right">镜像源:</label>
                            <div class="col-sm-9">
                                <input type="text" class="easyui-validatebox form-control" data-options="required:true" name="imageResource" id="imageResource">
                            </div>
                        </div>

                        <div class="col-sm-4 col-xs-4">
                            <label for="channels" class="col-sm-3 control-label no-padding-right">渠道:</label>
                            <div class="col-sm-9">
                                <input type="text" class="easyui-validatebox form-control" data-options="required:true" name="channels" id="channels" placeholder="请输入渠道" style="width:60%">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-sm-4 col-xs-4">
                            <label for="catagory" class="col-sm-3 control-label no-padding-right">镜像类型:</label>
                            <div class="col-sm-9">
                                <select id="catagory" name="catagory" class="easyui-combobox easyui-validatebox" data-options="required:true" style="height: 30px;width: 300px;">
                                    <option value="db">数据库</option>
                                    <option value="service">服务器</option>
                                    <option value="sys">系统平台</option>
                                    <option value="pl">编程语言</option>
                                    <option value="mq">消息队列</option>
                                    <option value="tool">运维工具</option>
                                    <option value="web">WEB框架</option>
                                    <option value="other">其他</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-sm-4 col-xs-4">
                            <label for="picture" class="col-sm-3 control-label no-padding-right">图片上传:</label>
                            <div class="col-sm-9">
                                <input  type="text" id="picture" name="picture"  style="width:260px;height:25px;" >

                            </div>
                        </div>

                        <div id="showimg" class="form-group col-sm-4 col-xs-4" hidden="true">

                        </div>
                    </div>



                    <div class="form-group" >
                        <label for="simpleIntroduction" class="col-sm-1 control-label no-padding-right">简介:</label>
                        <div class="col-sm-11" >
                            <input  class="easyui-textbox " name="simpleIntroduction" data-options="multiline:true" id="simpleIntroduction"   style="width:100%;height:100px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editormd" class="col-sm-1 control-label no-padding-right">详情:</label>
                        <div class="editormd editormd-vertical" id="editormd" name="editormd">
                            <textarea class="editormd-markdown-textarea" id="detailIntroduction" name="detailIntroduction" style="display: none"></textarea>
                        </div>
                    </div>

                    <input class="easyui-validatebox form-control" type="hidden" name="imageCode" id="imageCode">
                </form>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" charset="utf-8" src="{{projcfg.appurl}}/static/js/ueditor/ueditor.config.js"></script>
<script type="text/javascript" cahrset="utf-8" src="{{projcfg.appurl}}/static/js/ueditor/ueditor.all.js"></script>
<script  type="text/javascript">
    $(function(){
        var ue=UE.getEditor('simpleIntroduction')
    });

    $(function(){
        console.info("执行加载")
        $('#myImageDataTable').datagrid({
            url:'{{projcfg.appurl}}/api/project/ability/imagemanage/develop/im/pageList',
            method:'get',
            rownumbers:false,
            striped:true,
            fitColumns:true,
            fit:true,
            border:true,
            singleSelect:true,
            selectOnCheck:false,
            columns:[[
                {"field": "imageCode", checkbox:true},
                {"field": "imageName","title":" 镜像名称","width":80,align:"center"},
                {"field": "channels","title":"渠道","width":100,align:"center"},
                {"field": "picture","title":"图片","width":80,align:"center","formatter":function(value,rowDate,rowIndex){
                    return '<img src="data:'+rowDate.pictureType+";base64 ,"+rowDate.picture+'"  style="height:35px;width:35px">';
                }},
                {"field":"imageVersion","title":"版本","width":100,align:"center","formatter":function(value,rowData,rowIndex){
                    return getVerData(rowData.imageCode,rowIndex);
                }},
                {"field": "simpleIntroduction","title":"简介","width":150,align:"center"},
                {"field": "catagory","title":"类型","width":50,align:"center","formatter":function(value,rowData,rowIndex){
                    return convertCatagory(value);
                }},
                {"field": "collectionNumber","title":"收藏数","width":50,align:"center"},
                {"field": "downloadNumber","title":"下载数","width":50,align:"center"},
                {"field": "recommend","title":"是否推荐","width":50,align:"center","formatter":function(value,rowData,rowIndex){
                   if(value==1)
                    return "推荐";
                   else
                       return "不推荐";
                }},
                {"field":"imageTime","title":"创建时间","width":100,align:"center"},
                {"field": "imageResource",hidden:'true'}
            ]],
            onLoadError:function() {
                msgError('加载数据出现时发生错误,请稍候重试...');
            },
            pagination:true,
            loadMsg:'正在加载...'
        });

    });

    function convertCatagory(value){
        var returnvalue = '';
        if(value == "db"){
            returnvalue = "数据库";
        }else if(value == "service"){
            returnvalue = "服务器";
        }else if(value == "sys"){
            returnvalue = "系统平台";
        }else if(value == "pl"){
            returnvalue = "编程语言";
        }else if(value == "mq"){
            returnvalue = "消息队列";
        }else if(value == "tool"){
            returnvalue = "运维工具";
        }else if(value == "web"){
            returnvalue = "WEB框架";
        }else if(value == "other"){
            returnvalue = "其他";
        }
        return returnvalue;
    }

    function getVerData(imageCode,rowIndex){
        var flag = "vers"+rowIndex;
        var select = "<select id=\""+flag+"\" class=\"easyui-combobox\" name=\""+flag+"\" style=\"width:130px;\">";
        if(imageCode){
            $.ajax({
                url: '{{projcfg.appurl}}/api/project/ability/imagemanage/develop/im/verList',
                type: 'get',
                async:false,
                data: {'imageCode':imageCode},
                success: function (data) {
                    console.log(data);
                    if(data.success) {
                        var verdata = verAarry(data.data);
                        console.log("==",verdata);
                        for(var i=0;i<verdata.length;i++){
                            select += "<option value='"+verdata[i]+"'>"+verdata[i]+"</option>";
                        }
                    }
                    else {
                        msgError(data.msg+',错误代码:'+data.code);
                    }
                }
            });
        }
        select +=  '</select>';
        return select;
    }

    function verAarry(data){
        var arr = [];
        for(var i=0;i<data.length;i++){
            arr.push(data[i].imageVersion);
        }
        //进行倒序排序
        arr.sort(function(o1,o2){
            var a1 = o1.replace('v','').split('.');
            var a2 = o2.replace('v','').split('.');
            var length = Math.max(a1.length,a2.length);
            for(var i = 0; i < length; i++){
                var n1 = parseInt(a1[i] || 0);
                var n2 = parseInt(a2[i] || 0);
                if(n1 - n2 != 0){
                    return n2 - n1;
                }
            }
        });
        return arr;
    }

    function openPage(id,title, value, callback) {
        $('#'+id).show();
        $("#picture").filebox({
            buttonText:'选择图片',
            buttonAlign:'left',
            accept:'image/*',
            multiple:'false'
        });
        $("#appPicture").filebox({
            buttonText:'选择图片',
            buttonAlign:'left',
            accept:'image/*',
            multiple:'multiple'
        });
        $('#'+id).mydialog({
            title:title,
            width: '85%',
            height: 650,
            top:100,
            modal: true,
            myButtons:[
                {
                    text:'确定',
                    btnCls:'btn btn-blue',
                    handler:function(){
                        callback(id);
                    }
                },
                {
                    text:'关闭',
                    btnCls:'btn btn-danger',
                    handler:function(){
                        closeDialog(id);
                    }
                }
            ]
        });
    }
    function modifyPage(id,title,value,callback){
        var rows = $('#myImageDataTable').datagrid('getChecked');
        if(rows.length!=1){
            msgError("提示，请选择一条数据再进行修改");
            return false;
        }
        var imageCode=rows[0].imageCode;
        $('#addimage').form("clear");
        var modal=$('#addimage');
        $("#showimg").show().html('<label for="picture" class="col-sm-3 control-label no-padding-right">原图:</label><div class="col-sm-9"><img src="data:'+rows[0].pictureType+";base64 ,"+rows[0].picture+'"  style="height:35px;width:35px"></div>');
//        if(rows[0].pictureNames==null||rows[0].pictureNames==""||rows[0].pictureNames==undefined) {
//            $("#showappimg").show().html('<label for="appPicture" class="col-sm-3 control-label no-padding-right">应用截图:</label><div class="col-sm-9">暂无</div>');
//        }else{
//
//            $("#showappimg").show().html('<label for="appPicture" class="col-sm-3 control-label no-padding-right">应用截图:</label><a class="col-sm-9">' + rows[0].pictureNames + '</a>');
//        }
        delete rows[0].picture;
        delete rows[0].pictureName;
        delete rows[0].pictureType;
        delete rows[0].appPicture;
        console.info(rows[0]);
        console.log(typeof rows[0]);
//        var ue1=UE.getEditor('simpleIntroduction');
        if(rows[0].simpleIntroduction){
            $("#simpleIntroduction").attr("value",rows[0].simpleIntroduction);
        }
        //给编辑器赋值没有成功，因为load的row[0]中没有detailIntroduction的值
        if(rows[0].detailIntroduction){
            $("#detailIntroduction").attr("value",rows[0].detailIntroduction);
        }

        modal.form('load',rows[0]);
        $("#picture").filebox({
            buttonText:'选择图片',
            buttonAlign:'left',
            accept:'image/*',
            multiple:'false'
        });

        $(function() {
           var edit=editormd("editormd", {
                width   : "85%",
                height  : 250,
                syncScrolling : "single",
                //你的lib目录的路径，我这边用JSP做测试的
                path    : "{{projcfg.appurl}}/static/ability/editormd/lib/",
                //这个配置在simple.html中并没有，但是为了能够提交表单，使用这个配置可以让构造出来的HTML代码直接在第二个隐藏的textarea域中，方便post提交表单。
//                saveHTMLToTextarea : true,
               imageUpload : true,
               imageFormats : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
               imageUploadURL : '{{projcfg.appurl}}/api/project/ability/imagemanage/develop/im/base64Pic',
//               saveHTMLToTextarea : true,

            });
        });




        openPage('addimage',title,'',callback);
    }


    function doSearch() {
        $('#myImageDataTable').datagrid('reload');
    }
    function doClear() {
        doSearch();
    }
    //修改和新增共同使用一个接口 区分判断条件 通过imageCode是否存在来判断
    function doAddAndModify(id) {
        $('#imageForm').form("submit",{
            url: '{{projcfg.appurl}}/api/project/ability/imagemanage/develop/im/add',
            onSubmit:function(){
                var validate = $(this).form('validate');
                if(!validate) {
                    return false;
                }
            },
            success:function(data){
                data = JSON.parse(data)
                if(data.success){
                    msgSuccess(data.msg);
                    $('#myImageDataTable').datagrid("reload");
                    closeDialog(id);
                }else{
                    msgError(data.msg+',错误代码:'+data.code);
                }
            }
        });

    }

    // 打开页面


    // 清空新增表单数据
    function clear() {
        $('#addimage').form('clear');
    }

    // 关闭窗口
    function closeDialog(id) {
        $('#'+id).dialog('close');
        clear();
    }
    // 获得选择行
    function doDelete(){
        var rows = $('#myImageDataTable').datagrid('getChecked');
        if (rows.length != 1) {
            bootbox.alert('提示,请选择一条数据再进行删除', function(result){
            });
            return false;
        }
        console.info(rows);
        bootbox.confirm('确定删除此条记录？',function (result){
            if(result){
                // 获取远程数据
                $.ajax({
                    url: '{{projcfg.appurl}}/api/project/ability/imagemanage/develop/im/'+ rows[0].imageCode,
                    type: 'delete',

                    success: function (data) {
                        if(data.success) {
                            msgSuccess(data.msg);
                            $('#myImageDataTable').datagrid('reload');
                        }
                        else {
                            msgError(data.msg+',错误代码:'+data.code);
                        }
                    }
                });
            }
        });
    }


</script>